<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito Snake</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #e6ecf0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 50px;
      margin-top: 30px;
    }
    .header h2, .header #puntos {
      margin: 0;
    }
    #puntos, #vidas {
      font-size: 22px;
      font-weight: bold;
      color: #2c3e50;
    }
    #mensaje {
      font-size: 22px;
      font-weight: bold;
      color: #e74c3c;
      margin: 12px;
      display: none;
    }
    #timerBar {
      width: 100%;
      max-width: 600px;
      height: 15px;
      background-color: #ccc;
      margin: 10px auto;
      border-radius: 10px;
      overflow: hidden;
    }
    #timerProgress {
      height: 100%;
      width: 100%;
      background-color: #4caf50;
      transition: width 1s linear;
    }
    #nivelML {
      font-size: 18px;
      color: #333;
      margin: 8px;
    }
    #pista {
      position: relative;
      width: 550px;
      height: 300px;
      background: url("pista.png") center/cover no-repeat;
      border: 4px solid #34495e;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin: 20px auto 40px auto;
      overflow: hidden;
    }
    #carrito {
      position: absolute;
      width: 50px;
      height: 100px;
      transition: transform 0.5s ease-in-out;
      transform: rotate(0deg);
    }
    #moneda {
      position: absolute;
      width: 30px;
      height: 30px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Carrito Snake</h2>
    <div id="puntos">Puntos: 0</div>
  </div>
  <div id="mensaje">¡Chocaste!</div>
  <div id="nivelML">Nivel: --</div>
  <div id="timerBar"><div id="timerProgress"></div></div>
  <div id="pista">
    <img id="carrito" src="carro.png" alt="Carrito">
    <img id="moneda" src="moneda.png" alt="Moneda">
  </div>

  <script>
    const carrito = document.getElementById("carrito");
    const moneda = document.getElementById("moneda");
    const pista = document.getElementById("pista");
    const mensaje = document.getElementById("mensaje");
    const nivelML = document.getElementById("nivelML");
    const timerProgress = document.getElementById("timerProgress");

    let puntos = 0;
    const paso = 10;
    let angulo = 0;
    let direccionActual = "U";

    let x, y;
    let velocidad = 300;
    let movimientoActivo = false;

    let colisiones = 0;
    let giros = 0;
    let tiempoAnterior = Date.now();
    let inicioJuego = Date.now();
    let tiempos = [];
    let tiempoMaximo = 30;
    let tiempoRestante = tiempoMaximo;
    let intervaloTimer;

    function colocarMoneda() {
      const maxX = pista.clientWidth - 30;
      const maxY = pista.clientHeight - 30;
      const randX = Math.floor(Math.random() * maxX);
      const randY = Math.floor(Math.random() * maxY);
      moneda.style.left = randX + "px";
      moneda.style.top = randY + "px";
      tiempoRestante = Math.min(tiempoMaximo, tiempoRestante + tiempoMaximo * 0.25);
      actualizarBarra();
    }

    function actualizarBarra() {
      const porcentaje = (tiempoRestante / tiempoMaximo) * 100;
      timerProgress.style.width = porcentaje + "%";
    }

    function actualizarBarraTiempo() {
      tiempoRestante--;
      actualizarBarra();
      if (tiempoRestante <= 0) {
        clearInterval(intervaloTimer);
        alert("¡Tiempo agotado!");
        finalizarJuego();
        reiniciarJuego();
      }
    }

    function iniciarTimer() {
      clearInterval(intervaloTimer);
      tiempoRestante = tiempoMaximo;
      actualizarBarra();
      intervaloTimer = setInterval(actualizarBarraTiempo, 1000);
    }

    function posicionInicial() {
      x = (pista.clientWidth - carrito.clientWidth) / 2;
      y = (pista.clientHeight - carrito.clientHeight) / 2;
      carrito.style.left = x + "px";
      carrito.style.top = y + "px";
      angulo = 0;
      carrito.style.transform = `rotate(${angulo}deg)`;
      direccionActual = "U";
    }

    function detectarColisionMoneda() {
      const rc = carrito.getBoundingClientRect();
      const rm = moneda.getBoundingClientRect();
      const overlap = !(rc.right < rm.left || rc.left > rm.right || rc.bottom < rm.top || rc.top > rm.bottom);
      if (overlap) {
        puntos++;
        document.getElementById("puntos").textContent = "Puntos: " + puntos;
        tiempos.push((Date.now() - tiempoAnterior) / 1000);
        tiempoAnterior = Date.now();
        colocarMoneda();
        giros = 0;
        actualizarBarra();
      }
    }

    function detectarColisionBorde() {
      const pistaWidth = pista.clientWidth;
      const pistaHeight = pista.clientHeight;
      const carritoWidth = carrito.clientWidth;
      const carritoHeight = carrito.clientHeight;
      return x < 0 || x > pistaWidth - carritoWidth || y < 0 || y > pistaHeight - carritoHeight;
    }

    function rotar(direccion) {
      if (!movimientoActivo) return;
      const dirs = ["U", "R", "D", "L"];
      let index = dirs.indexOf(direccionActual);
      if (direccion === "R") {
        direccionActual = dirs[(index + 1) % 4];
        angulo += 90;
      } else if (direccion === "L") {
        direccionActual = dirs[(index + 3) % 4];
        angulo -= 90;
      }
      carrito.style.transform = `rotate(${angulo}deg)`;
      giros++;
    }

    function moverPaso() {
      if (!movimientoActivo) return;

      let dx = 0, dy = 0;
      if (direccionActual === "U") dy = -1;
      else if (direccionActual === "D") dy = 1;
      else if (direccionActual === "L") dx = -1;
      else if (direccionActual === "R") dx = 1;

      x += dx * paso;
      y += dy * paso;

      if (detectarColisionBorde()) {
        colisiones++;
        mensaje.style.display = "block";
        setTimeout(() => mensaje.style.display = "none", 1000);
        tiempoRestante = Math.max(1, tiempoRestante - tiempoMaximo * 0.25);
        actualizarBarra();
        posicionInicial();
      } else {
        carrito.style.left = x + "px";
        carrito.style.top = y + "px";
      }

      detectarColisionMoneda();
    }

    function finalizarJuego() {
      clearInterval(intervaloTimer);
      movimientoActivo = false;
      const promedio = tiempos.length ? tiempos.reduce((a, b) => a + b, 0) / tiempos.length : 5;
      const tiempoTotalRonda = (Date.now() - inicioJuego) / 1000;

      fetch("https://hci-car-remote.onrender.com/predecir", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          tiempo: promedio,
          giros: giros,
          colisiones: colisiones,
          puntos: puntos,
          tiempo_total: tiempoTotalRonda
        })
      })
      .then(res => res.json())
      .then(data => {
        nivelML.textContent = `Nivel: ${data.nivel}`;
        alert(`Nivel detectado: ${data.nivel}`);
      })
      .catch(() => alert("Error al clasificar el nivel"));
    }

    function reiniciarJuego() {
      puntos = 0;
      colisiones = 0;
      giros = 0;
      tiempos = [];
      movimientoActivo = false;
      document.getElementById("puntos").textContent = "Puntos: 0";
      posicionInicial();
    }

    document.addEventListener("keydown", (e) => {
      const tecla = e.key.toLowerCase();

      if (!movimientoActivo && (tecla === "arrowup" || tecla === "w")) {
        movimientoActivo = true;
        inicioJuego = Date.now();
        tiempoAnterior = Date.now();
        iniciarTimer();
      }

      if (!movimientoActivo) return;

      if (tecla === "arrowleft" || tecla === "a") rotar("L");
      else if (tecla === "arrowright" || tecla === "d") rotar("R");
    });

    setInterval(moverPaso, 300);
    posicionInicial();
    colocarMoneda();

    // Ejecutar comando desde la URL si viene desde MIT App
    window.addEventListener("load", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const comando = urlParams.get("cmd");
      if (comando) {
        movimientoActivo = true;
        iniciarTimer();
        inicioJuego = Date.now();
        tiempoAnterior = Date.now();
        const evento = new KeyboardEvent("keydown", { key: comando.toLowerCase() });
        document.dispatchEvent(evento);
      }
    });

  </script>
</body>
</html>
