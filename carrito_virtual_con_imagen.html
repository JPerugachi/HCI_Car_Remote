<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito Snake</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #e6ecf0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 50px;
      margin-top: 30px;
    }
    #puntos, #vidas {
      font-size: 22px;
      font-weight: bold;
      color: #2c3e50;
    }
    #mensaje {
      font-size: 22px;
      font-weight: bold;
      color: #e74c3c;
      margin: 12px;
      display: none;
    }
    #timerBar {
      width: 100%;
      max-width: 600px;
      height: 15px;
      background-color: #ccc;
      margin: 10px auto;
      border-radius: 10px;
      overflow: hidden;
    }
    #timerProgress {
      height: 100%;
      width: 100%;
      background-color: #4caf50;
      transition: width 1s linear;
    }
    #nivelML {
      font-size: 18px;
      color: #333;
      margin: 8px;
    }
    #pista {
      position: relative;
      width: 550px;
      height: 300px;
      background: url("static/pista.png") center/cover no-repeat;
      border: 4px solid #34495e;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin: 20px auto 40px auto;
      overflow: hidden;
    }
    #carrito {
      position: absolute;
      width: 50px;
      height: 100px;
      transition: transform 0.5s ease-in-out;
      transform: rotate(0deg);
    }
    #moneda {
      position: absolute;
      width: 30px;
      height: 30px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Carrito Snake</h2>
    <div id="puntos">Puntos: 0</div>
  </div>
  <div id="mensaje">¡Chocaste!</div>
  <div id="nivelML">Nivel: --</div>
  <div id="timerBar"><div id="timerProgress"></div></div>
  <div id="pista">
    <img id="carrito" src="static/carro.png" alt="Carrito">
    <img id="moneda"  src="static/moneda.png" alt="Moneda">
  </div>

  <script>
    // — Variables y setup inicial
    const carrito     = document.getElementById("carrito");
    const moneda      = document.getElementById("moneda");
    const pista       = document.getElementById("pista");
    const mensaje     = document.getElementById("mensaje");
    const nivelML     = document.getElementById("nivelML");
    const timerProg   = document.getElementById("timerProgress");

    let puntos         = 0;
    const paso         = 10;
    let angulo         = 0;
    let dirActual      = "U";

    let x, y;
    let movimientoActivo = false;

    let colisiones      = 0;
    let giros           = 0;
    let tiempos         = [];
    let tiempoMax       = 30;
    let tiempoRestante  = tiempoMax;
    let tiempoAnt       = Date.now();
    let inicioJuego     = Date.now();
    let intervaloTimer;

    function colocarMoneda() {
      const maxX = pista.clientWidth  - moneda.clientWidth;
      const maxY = pista.clientHeight - moneda.clientHeight;
      moneda.style.left = Math.random() * maxX + "px";
      moneda.style.top  = Math.random() * maxY + "px";
      tiempoRestante = Math.min(tiempoMax, tiempoRestante + tiempoMax * 0.25);
      actualizarBarra();
    }

    function actualizarBarra() {
      timerProg.style.width = (tiempoRestante/tiempoMax)*100 + "%";
    }

    function actualizarTimer() {
      tiempoRestante--;
      actualizarBarra();
      if (tiempoRestante <= 0) {
        clearInterval(intervaloTimer);
        alert("¡Tiempo agotado!");
        finalizarJuego();
        reiniciarJuego();
      }
    }

    function iniciarTimer() {
      clearInterval(intervaloTimer);
      tiempoRestante = tiempoMax;
      actualizarBarra();
      intervaloTimer = setInterval(actualizarTimer, 1000);
    }

    function posicionInicial() {
      x = (pista.clientWidth - carrito.clientWidth)/2;
      y = (pista.clientHeight - carrito.clientHeight)/2;
      carrito.style.left = x + "px";
      carrito.style.top  = y + "px";
      angulo           = 0;
      carrito.style.transform = `rotate(${angulo}deg)`;
      dirActual        = "U";
    }

    function detectarColisionMoneda() {
      const rc = carrito.getBoundingClientRect();
      const rm = moneda.getBoundingClientRect();
      if (!(rc.right < rm.left || rc.left > rm.right || rc.bottom < rm.top || rc.top > rm.bottom)) {
        puntos++;
        document.getElementById("puntos").textContent = "Puntos: " + puntos;
        tiempos.push((Date.now() - tiempoAnt)/1000);
        tiempoAnt = Date.now();
        colocarMoneda();
        giros = 0;
        actualizarBarra();
      }
    }

    function detectarColisionBorde() {
      return x < 0 || x > pista.clientWidth - carrito.clientWidth
          || y < 0 || y > pista.clientHeight - carrito.clientHeight;
    }

    function rotar(dir) {
      if (!movimientoActivo) return;
      const dirs = ["U","R","D","L"];
      let idx = dirs.indexOf(dirActual);
      if (dir === "R") {
        dirActual = dirs[(idx+1)%4];
        angulo   += 90;
      } else {
        dirActual = dirs[(idx+3)%4];
        angulo   -= 90;
      }
      carrito.style.transform = `rotate(${angulo}deg)`;
      giros++;
    }

    function moverPaso() {
      if (!movimientoActivo) return;
      let dx=0, dy=0;
      if (dirActual==="U") dy=-1;
      if (dirActual==="D") dy= 1;
      if (dirActual==="L") dx=-1;
      if (dirActual==="R") dx= 1;
      x += dx*paso; y += dy*paso;

      if (detectarColisionBorde()) {
        colisiones++;
        mensaje.style.display = "block";
        setTimeout(()=>mensaje.style.display="none",1000);
        tiempoRestante = Math.max(1, tiempoRestante - tiempoMax*0.25);
        actualizarBarra();
        posicionInicial();
      } else {
        carrito.style.left = x + "px";
        carrito.style.top  = y + "px";
      }
      detectarColisionMoneda();
    }

    function finalizarJuego() {
      clearInterval(intervaloTimer);
      movimientoActivo = false;
      const prom = tiempos.length
        ? tiempos.reduce((a,b)=>a+b,0)/tiempos.length
        : 5;
      const total = (Date.now()-inicioJuego)/1000;
      fetch("/predecir", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          tiempo: prom,
          giros, colisiones, puntos,
          tiempo_total: total
        })
      })
      .then(r=>r.json())
      .then(d=>{
        nivelML.textContent = `Nivel: ${d.nivel}`;
        alert(`Nivel detectado: ${d.nivel}`);
      })
      .catch(_=>alert("Error al clasificar"));
    }

    function reiniciarJuego() {
      puntos = giros = colisiones = 0;
      tiempos = [];
      movimientoActivo = false;
      document.getElementById("puntos").textContent = "Puntos: 0";
      posicionInicial();
    }

    // — Inicia el loop y la moneda
    setInterval(moverPaso, 300);
    posicionInicial();
    colocarMoneda();

    // ————————————————
    // Función pública para recibir comandos sin recargar
    window.handleCmd = function(cmd) {
      const c = cmd.toUpperCase();
      switch(c) {
        case "F": case "U":
          if (!movimientoActivo) {
            movimientoActivo = true;
            inicioJuego      = Date.now();
            tiempoAnt        = Date.now();
            iniciarTimer();
          }
          dirActual = "U"; angulo = 0;
          carrito.style.transform = `rotate(${angulo}deg)`;
          break;
        case "L":
          rotar("L"); break;
        case "R":
          rotar("R"); break;
        case "D":
          if (!movimientoActivo) {
            movimientoActivo = true;
            inicioJuego      = Date.now();
            tiempoAnt        = Date.now();
            iniciarTimer();
          }
          dirActual = "D"; angulo = 180;
          carrito.style.transform = `rotate(${angulo}deg)`;
          break;
      }
    };
  </script>
</body>
</html>
