<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito Snake</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#02d0ff; display:flex; flex-direction:column; align-items:center; }
    .header { display:flex; align-items:center; gap:40px; margin-top:30px; }
    .header h2 { font-family:'Orbitron',sans-serif; font-size:28px; color:#002f4b; margin:0; }
    #puntos, #nivelML { font-family:'Orbitron',sans-serif; font-size:22px; font-weight:bold; color:#002f4b; margin:12px 0; }
    #timerBar { width:100%; max-width:600px; height:15px; background:#ccc; border-radius:10px; overflow:hidden; }
    #timerProgress { height:100%; width:100%; background:#4caf50; transition:width 1s linear; }
    #pista { position:relative; width:550px; height:300px; background:url('pista.png') center/cover no-repeat; border:4px solid #003f66; border-radius:12px; overflow:hidden; margin:20px auto; }
    #carrito { position:absolute; width:50px; height:100px; transition:transform .5s ease-in-out; }
    #moneda { position:absolute; width:30px; height:30px; }
  </style>
</head>
<body>
  <div class="header">
    <h2>Carrito Snake</h2>
    <div id="puntos">Puntos: 0</div>
  </div>
  <div id="nivelML">Nivel ML: --</div>
  <div id="timerBar"><div id="timerProgress"></div></div>
  <div id="pista">
    <img id="carrito" src="carro.png" alt="Carrito">
    <img id="moneda" src="moneda.png" alt="Moneda">
  </div>
  <script>
    const carrito = document.getElementById('carrito');
    const moneda = document.getElementById('moneda');
    const pista = document.getElementById('pista');
    const nivelML = document.getElementById('nivelML');
    const timerProg = document.getElementById('timerProgress');

    let puntos = 0, giros = 0, colisiones = 0, angulo = 0, juegoActivo = true;
    const paso = 10, velocidad = 300, tiempoMax = 30;
    let x, y, tiempoRest = tiempoMax, timerInterval, inicioJuego;

    function posicionInicial() {
      x = (pista.clientWidth - carrito.clientWidth) / 2;
      y = (pista.clientHeight - carrito.clientHeight) / 2;
      carrito.style.left = `${x}px`;
      carrito.style.top = `${y}px`;
      carrito.style.transform = 'rotate(0deg)';
      angulo = 0;
      giros = 0; colisiones = 0; puntos = 0;
      tiempoRest = tiempoMax;
      inicioJuego = Date.now();
      document.getElementById('puntos').textContent = 'Puntos: 0';
      actualizarBarra();
      iniciarTimer();
    }

    function actualizarBarra() {
      timerProg.style.width = `${(tiempoRest / tiempoMax) * 100}%`;
    }
    function iniciarTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        tiempoRest--;
        actualizarBarra();
        if (tiempoRest <= 0) perderJuego();
      }, 1000);
    }

    function colocarMoneda() {
      const maxX = pista.clientWidth - moneda.clientWidth;
      const maxY = pista.clientHeight - moneda.clientHeight;
      moneda.style.left = `${Math.floor(Math.random() * maxX)}px`;
      moneda.style.top = `${Math.floor(Math.random() * maxY)}px`;
    }

    function detectarColMoneda() {
      const rc = carrito.getBoundingClientRect();
      const rm = moneda.getBoundingClientRect();
      if (!(rc.right < rm.left || rc.left > rm.right || rc.bottom < rm.top || rc.top > rm.bottom)) {
        puntos++;
        document.getElementById('puntos').textContent = `Puntos: ${puntos}`;
        tiempoRest = Math.min(tiempoMax, tiempoRest + tiempoMax * 0.25);
        actualizarBarra();
        colocarMoneda();
      }
    }

    function perderJuego() {
      clearInterval(timerInterval);
      if (!juegoActivo) return;
      juegoActivo = false;
      const duracion = (Date.now() - inicioJuego) / 1000;
      fetch('/predecir', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ tiempo: duracion, giros, colisiones, puntos })
      })
      .then(res => res.json())
      .then(data => nivelML.textContent = `Nivel ML: ${data.nivel}`)
      .catch(console.error);

      setTimeout(() => { juegoActivo = true; posicionInicial(); }, 1000);
    }

    function rotar(dir) {
      if (!juegoActivo) return;
      angulo += (dir === 'R' ? 90 : -90);
      carrito.style.transform = `rotate(${angulo}deg)`;
      giros++;
    }

    function moverPaso(sentido) {
      if (!juegoActivo) return;
      const rad = angulo * Math.PI / 180;
      let dx = Math.round(Math.sin(rad)), dy = -Math.round(Math.cos(rad));
      if (sentido === 'D') { dx *= -1; dy *= -1; }
      const nx = x + dx * paso, ny = y + dy * paso;
      if (nx < 0 || nx > pista.clientWidth - carrito.clientWidth || ny < 0 || ny > pista.clientHeight - carrito.clientHeight) {
        colisiones++;
        tiempoRest = Math.max(0, tiempoRest - tiempoMax * 0.25);
        actualizarBarra();
        posicionInicial();
      } else {
        x = nx; y = ny;
        carrito.style.left = `${x}px`;
        carrito.style.top = `${y}px`;
        detectarColMoneda();
      }
    }

    function iniciarLoopComandos() {
      setInterval(() => {
        fetch('/')
          .then(res => res.text())
          .then(cmd => {
            cmd = cmd.trim().toUpperCase();
            if (cmd === 'L' || cmd === 'R') rotar(cmd);
            else if (cmd === 'U' || cmd === 'D') moverPaso(cmd);
          })
          .catch(() => {});
      }, velocidad);
    }

    posicionInicial(); colocarMoneda(); iniciarLoopComandos();
  </script>